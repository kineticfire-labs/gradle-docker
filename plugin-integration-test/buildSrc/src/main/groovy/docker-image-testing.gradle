/*
 * (c) Copyright 2023-2025 gradle-docker Contributors. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * Docker Image Testing Library
 * 
 * Provides a composable library of functions to register Docker image testing tasks
 * for integration tests. Use explicit configuration for clear test specification.
 * 
 * Usage:
 *   apply from: "$rootDir/buildSrc/src/main/groovy/docker-image-testing.gradle"
 *   
 *   // Individual functions for maximum flexibility
 *   registerCleanDockerImagesTask(project, ['time-server:1.0.0', 'time-server:latest'])
 *   registerVerifyBuiltImagesTask(project, ['time-server:1.0.0', 'time-server:latest'])
 *   registerVerifySavedImagesTask(project, ['build/saved/time-server-1.0.0.tar.gz'])
 *   registerVerifyRegistryImagesTask(project, ['time-server:1.0.0'], 'localhost:5000')
 *   
 *   // Or convenience workflow function
 *   registerBuildWorkflowTasks(project, ['time-server:1.0.0', 'time-server:latest'])
 */

/**
 * Register Docker image clean task for removing images before building.
 * 
 * @param project The Gradle project to register tasks on
 * @param imageNames List of Docker image names in format "image-name:tag"
 */
ext.registerCleanDockerImagesTask = { Project project, List<String> imageNames ->
    if (imageNames == null || imageNames.isEmpty()) {
        throw new IllegalArgumentException("imageNames cannot be null or empty")
    }
    
    project.tasks.register('cleanDockerImages', DockerImageCleanTask) {
        it.imageNames.set(imageNames)
        it.group = 'verification'
        it.description = 'Remove Docker images before building to ensure clean integration test'
    }
    
    project.logger.info("Registered clean Docker images task for images: ${imageNames}")
}

/**
 * Register Docker image verification task for checking images exist after building.
 * 
 * @param project The Gradle project to register tasks on
 * @param imageNames List of Docker image names in format "image-name:tag"
 */
ext.registerVerifyBuiltImagesTask = { Project project, List<String> imageNames ->
    if (imageNames == null || imageNames.isEmpty()) {
        throw new IllegalArgumentException("imageNames cannot be null or empty")
    }
    
    project.tasks.register('verifyDockerImages', DockerImageVerifyTask) {
        it.imageNames.set(imageNames)
        it.group = 'verification'
        it.description = 'Verify Docker images were created with expected tags'
    }
    
    project.logger.info("Registered verify built images task for images: ${imageNames}")
}

/**
 * Register Docker saved image verification task for checking saved image files exist.
 * 
 * Supports multiple compression formats: .tar, .tar.gz, .tar.bz2, .tar.xz, .zip
 * 
 * @param project The Gradle project to register tasks on
 * @param filePaths List of file paths to saved Docker images (full paths with extensions)
 */
ext.registerVerifySavedImagesTask = { Project project, List<String> filePaths ->
    if (filePaths == null || filePaths.isEmpty()) {
        throw new IllegalArgumentException("filePaths cannot be null or empty")
    }
    
    project.tasks.register('verifySavedDockerImages', DockerSavedImageVerifyTask) {
        it.filePaths.set(filePaths)
        it.group = 'verification'
        it.description = 'Verify Docker image files exist and can be loaded by Docker'
    }
    
    project.logger.info("Registered verify saved images task for files: ${filePaths}")
}

/**
 * Register Docker registry image verification task.
 * 
 * Supports two modes:
 * 1. Single Registry: Verify images in one registry (List parameter)
 * 2. Multiple Registries: Verify images across multiple registries (Map parameter)
 *
 * Mode detection is automatic based on parameter type.
 *
 * SINGLE REGISTRY MODE:
 * @param project The Gradle project
 * @param imageReferences List<String> - Image references for single registry
 * @param username Optional username for authentication
 * @param password Optional password for authentication
 * @param server Optional server for authentication
 *
 * MULTIPLE REGISTRY MODE:
 * @param project The Gradle project
 * @param imageReferencesByRegistry Map<String, List<String>> - Registry names to image references
 * @param authByRegistry Optional Map<String, Map<String, String>> - Registry auth credentials
 *
 * Examples:
 *   // Single registry
 *   registerVerifyRegistryImagesTask(project, ['localhost:5000/app:latest'])
 *
 *   // Single registry with auth
 *   registerVerifyRegistryImagesTask(project, ['localhost:5000/app:latest'], 'user', 'pass', 'localhost:5000')
 *
 *   // Multiple registries
 *   registerVerifyRegistryImagesTask(project, [
 *       'registry1': ['localhost:5070/app:latest'],
 *       'registry2': ['localhost:5071/app:latest']
 *   ])
 *
 *   // Multiple registries with auth
 *   registerVerifyRegistryImagesTask(
 *       project,
 *       ['registry1': ['localhost:5070/app:latest'], 'registry2': ['localhost:5071/app:latest']],
 *       ['registry2': [username: 'user', password: 'pass', server: 'localhost:5071']]
 *   )
 */
ext.registerVerifyRegistryImagesTask = { Project project, def imageReferencesOrMap, def usernameOrAuth = null, String password = null, String server = null ->
    
    if (imageReferencesOrMap instanceof List) {
        // SINGLE REGISTRY MODE (existing behavior)
        def imageReferences = imageReferencesOrMap as List<String>
        
        if (imageReferences == null || imageReferences.isEmpty()) {
            throw new IllegalArgumentException("imageReferences cannot be null or empty")
        }

        project.tasks.register('verifyRegistryDockerImages', DockerRegistryImageVerifyTask) {
            it.imageReferences.set(imageReferences)
            if (usernameOrAuth != null && usernameOrAuth instanceof String) {
                it.registryUsername.set(usernameOrAuth as String)
            }
            if (password != null) {
                it.registryPassword.set(password)
            }
            if (server != null) {
                it.registryServer.set(server)
            }
            it.group = 'verification'
            it.description = "Verify Docker images exist in registry"
        }

        project.logger.info("Registered single-registry verification task for images: ${imageReferences}")
        
    } else if (imageReferencesOrMap instanceof Map) {
        // MULTIPLE REGISTRY MODE (new behavior)
        def imageReferencesByRegistry = imageReferencesOrMap as Map<String, List<String>>
        def authByRegistry = (usernameOrAuth instanceof Map) ? (usernameOrAuth as Map<String, Map<String, String>>) : [:]
        
        if (imageReferencesByRegistry == null || imageReferencesByRegistry.isEmpty()) {
            throw new IllegalArgumentException("imageReferencesByRegistry cannot be null or empty")
        }

        // Create a verification task for each registry
        imageReferencesByRegistry.each { registryName, imageReferences ->
            def taskName = "verifyRegistryDockerImages${registryName.capitalize()}"
            
            def auth = authByRegistry[registryName]
            
            project.tasks.register(taskName, DockerRegistryImageVerifyTask) {
                it.imageReferences.set(imageReferences)
                
                if (auth != null) {
                    if (auth.username != null) {
                        it.registryUsername.set(auth.username)
                    }
                    if (auth.password != null) {
                        it.registryPassword.set(auth.password)
                    }
                    if (auth.server != null) {
                        it.registryServer.set(auth.server)
                    }
                }
                
                it.group = 'verification'
                it.description = "Verify Docker images exist in ${registryName} registry"
            }
            
            project.logger.info("Registered registry verification task '${taskName}' for ${registryName}: ${imageReferences}")
        }
        
        // Create an aggregate task that depends on all individual registry verification tasks
        project.tasks.register('verifyRegistryDockerImages') {
            it.group = 'verification'
            it.description = 'Verify Docker images exist in all configured registries'
            
            imageReferencesByRegistry.each { registryName, _ ->
                it.dependsOn "verifyRegistryDockerImages${registryName.capitalize()}"
            }
        }
        
        project.logger.info("Registered multi-registry aggregate verification task for ${imageReferencesByRegistry.size()} registries")
        
    } else {
        throw new IllegalArgumentException("First parameter must be either List<String> or Map<String, List<String>>")
    }
}

/**
 * Register build workflow tasks: clean → build → verify built images.
 * 
 * Convenience function for common Docker integration test workflow.
 * 
 * @param project The Gradle project to register tasks on
 * @param imageNames List of Docker image names in format "image-name:tag"
 */
ext.registerBuildWorkflowTasks = { Project project, List<String> imageNames ->
    registerCleanDockerImagesTask(project, imageNames)
    registerVerifyBuiltImagesTask(project, imageNames)
    
    project.logger.info("Registered build workflow tasks for images: ${imageNames}")
}

/**
 * Register Docker build args verification task.
 *
 * Verifies that Docker images were built with expected build arguments by parsing
 * the docker history output. Supports verification of images with zero, one, or
 * multiple build args.
 *
 * @param project The Gradle project to register tasks on
 * @param buildArgsPerImage Map of image references to their expected build args
 *                          Format: ['image:tag': ['ARG_NAME': 'value', ...]]
 *                          Empty map for an image means expect zero build args
 */
ext.registerVerifyBuildArgsTask = { Project project, Map<String, Map<String, String>> buildArgsPerImage ->
    if (buildArgsPerImage == null || buildArgsPerImage.isEmpty()) {
        throw new IllegalArgumentException("buildArgsPerImage cannot be null or empty")
    }

    project.tasks.register('verifyDockerBuildArgs', DockerBuildArgsVerifyTask) {
        it.imageNames.set(buildArgsPerImage.keySet().toList())
        it.expectedBuildArgs.set(buildArgsPerImage)
        it.strictMode.set(true)  // Default to exact match
        it.group = 'verification'
        it.description = 'Verify Docker images were built with expected build arguments'
    }

    project.logger.info("Registered build args verification for images: ${buildArgsPerImage.keySet()}")
}

/**
 * Register Docker labels verification task.
 *
 * Verifies that Docker images contain expected labels set via the plugin DSL.
 * Uses subset matching - verifies expected labels are present but allows
 * additional labels from base images and Dockerfile LABEL instructions.
 *
 * @param project The Gradle project to register tasks on
 * @param labelsPerImage Map of image references to their expected labels
 *                       Format: ['image:tag': ['label.key': 'value', ...]]
 *                       Empty map for an image means skip verification (no custom labels)
 */
ext.registerVerifyLabelsTask = { Project project, Map<String, Map<String, String>> labelsPerImage ->
    if (labelsPerImage == null || labelsPerImage.isEmpty()) {
        throw new IllegalArgumentException("labelsPerImage cannot be null or empty")
    }

    project.tasks.register('verifyDockerLabels', DockerLabelsVerifyTask) {
        it.imageNames.set(labelsPerImage.keySet().toList())
        it.expectedLabels.set(labelsPerImage)
        it.group = 'verification'
        it.description = 'Verify Docker images contain expected labels'
    }

    project.logger.info("Registered labels verification for images: ${labelsPerImage.keySet()}")
}

/**
 * Note: Advanced registry testing workflow is available via RegistryManagementPlugin.
 * See registry-integration-example.gradle in test resources for usage patterns.
 */