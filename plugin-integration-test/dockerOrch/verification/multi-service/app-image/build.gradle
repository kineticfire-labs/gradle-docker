plugins {
    id 'groovy'
    id 'com.kineticfire.gradle.gradle-docker'
}

group = 'com.kineticfire.test'
version = '1.0.0'

repositories {
    mavenCentral()
}

// Docker image configuration with Provider API
def jarFileProvider = project(':dockerOrch:verification:multi-service:app').tasks.named('bootJar')
    .flatMap { it.archiveFile }
def jarFileNameProvider = jarFileProvider.map { it.asFile.name }

docker {
    images {
        multiServiceApp {
            imageName = 'verification-multi-service-app'
            tags = ['latest', '1.0.0']
            contextTask = tasks.register('prepareMultiServiceContext', Copy) {
                into layout.buildDirectory.dir('docker-context/multiServiceApp')
                from('src/main/docker')
                from(jarFileProvider) {
                    rename { jarFileNameProvider.get() }
                }
                dependsOn project(':dockerOrch:verification:multi-service:app').tasks.named('bootJar')
            }
            buildArgs.put('JAR_FILE', jarFileNameProvider)
        }
    }
}

dockerOrch {
    composeStacks {
        multiServiceTest {
            files.from('src/integrationTest/resources/compose/multi-service.yml')
            projectName = 'verification-multi-service'
            waitForHealthy {
                waitForServices.set(['multi-service-app'])
                timeoutSeconds.set(120)
                pollSeconds.set(2)
            }
            waitForRunning {
                waitForServices.set(['postgres', 'redis', 'nginx'])
                timeoutSeconds.set(60)
                pollSeconds.set(1)
            }
        }
    }
}

// Configure integration test with system properties
tasks.named('integrationTest') {
    // Pass state file location to tests (lazy)
    systemProperty 'STATE_FILE_PATH',
        layout.buildDirectory.file('compose-state/multiServiceTest-state.json').get().asFile.absolutePath

    // Pass project name for validators
    systemProperty 'COMPOSE_PROJECT_NAME', 'verification-multi-service'
}

// Task dependencies - ensure proper ordering
afterEvaluate {
    tasks.named('composeUpMultiServiceTest') {
        dependsOn tasks.named('dockerBuildMultiServiceApp')
    }

    tasks.named('integrationTest') {
        dependsOn tasks.named('composeUpMultiServiceTest')
        finalizedBy tasks.named('composeDownMultiServiceTest')
        outputs.upToDateWhen { false }
    }
}

dependencies {
    testImplementation libs.groovy.all
    testImplementation libs.spock.core
    testRuntimeOnly libs.junit.platform.launcher

    integrationTestImplementation files("${rootProject.projectDir}/buildSrc/build/classes/groovy/main")
}

// Custom task for running integration test with cleanup
tasks.register('runIntegrationTest') {
    group = 'verification'
    description = 'Clean, build, compose up, run integration tests, and compose down'

    dependsOn 'clean'
    dependsOn 'dockerBuildMultiServiceApp'
    dependsOn 'composeUpMultiServiceTest'
    dependsOn 'integrationTest'
    finalizedBy 'composeDownMultiServiceTest'

    tasks.findByName('dockerBuildMultiServiceApp').mustRunAfter 'clean'
    tasks.findByName('composeUpMultiServiceTest').mustRunAfter 'dockerBuildMultiServiceApp'
    tasks.findByName('integrationTest').mustRunAfter 'composeUpMultiServiceTest'

    doLast {
        println "Integration test complete for verification:multi-service"
    }
}
