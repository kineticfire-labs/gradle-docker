/*
 * (c) Copyright 2023-2025 gradle-docker Contributors. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * dockerProject Integration Test: Scenario 2 - SourceRef Mode
 *
 * This scenario demonstrates the simplified dockerProject DSL for using existing
 * Docker Hub images via sourceRef component properties.
 *
 * What this tests:
 * - dockerProject single-block configuration with sourceRef mode
 * - sourceRef component properties (registry, namespace, imageName, tag)
 * - pullIfMissing behavior for pulling images from Docker Hub
 * - test block with compose and waitForRunning (nginx has no health check)
 * - onSuccess block with additionalTags
 * - Automatic translation to docker/dockerTest/dockerWorkflows DSLs
 *
 * Key differences from Build Mode (Scenario 1):
 * - No jarFrom/contextDir/dockerfile properties
 * - Uses sourceRef* properties to reference an existing image
 * - No build task is generated (image already exists)
 * - Tags are applied to the pulled image locally
 *
 * Port allocation (per README conventions):
 * - Service: 9301 (dockerProject scenario 2)
 */

plugins {
    id 'groovy'
    id 'com.kineticfire.gradle.docker'
}

repositories {
    mavenLocal()
    mavenCentral()
}

dependencies {
    testImplementation libs.groovy.all
    testImplementation libs.spock.core
    testRuntimeOnly libs.junit.platform.launcher
}

// =============================================================================
// DOCKER PROJECT DSL: SourceRef Mode - Using existing Docker Hub images
// =============================================================================
// This demonstrates how to use the dockerProject DSL with an existing image
// from Docker Hub instead of building from a Dockerfile.
//
// KEY CONCEPT: In sourceRef mode, the plugin:
// 1. Pulls the source image from Docker Hub (if pullIfMissing=true)
// 2. Tags it with additional tags (applied to the SOURCE image reference)
// 3. The compose file should reference the SOURCE image tag
//
// This is different from build mode where a new image is created with a custom name.
dockerProject {
    // image block: Reference an existing Docker Hub image
    image {
        // SourceRef component properties: specify the existing image to use
        // These properties identify the source image on Docker Hub
        sourceRefRegistry.set('docker.io')       // Docker Hub registry
        sourceRefNamespace.set('library')        // Official images namespace
        sourceRefImageName.set('nginx')          // Image name
        sourceRefTag.set('1.27-alpine')          // Specific version tag (alpine for smaller size)
        // Effective sourceRef: docker.io/library/nginx:1.27-alpine

        // Image name for internal task naming and pipeline generation
        // In sourceRef mode, this doesn't create a new local image name
        name.set('project-scenario2-nginx')

        // Tags to apply to the source image (these become additional references)
        // Note: In sourceRef mode, these tags are aliases to the source image
        tags.set(['latest', '1.27'])

        // Pull the image if it's not present locally
        // When true, the plugin will pull from Docker Hub if the image is missing
        pullIfMissing.set(true)

        // Note: No pullAuth needed for public Docker Hub images
        // For private registries, you would add:
        // pullAuth {
        //     username.set(System.getenv('DOCKER_USER'))
        //     password.set(System.getenv('DOCKER_PASS'))
        // }
    }

    // test block: Configure Docker Compose stack and test execution
    test {
        // Path to the Docker Compose file
        // IMPORTANT: In sourceRef mode, the compose file should reference the SOURCE tag
        // (e.g., nginx:1.27-alpine) not a custom local name
        compose.set('src/integrationTest/resources/compose/nginx.yml')

        // Services to wait for RUNNING status before running tests
        // Note: nginx:alpine doesn't have a health check, so we use waitForRunning
        // instead of waitForHealthy
        waitForRunning.set(['nginx'])

        // Timeout for container status checks (default: 60)
        timeoutSeconds.set(60)

        // Poll interval for status checks (default: 2)
        pollSeconds.set(2)

        // Test task to execute (default: 'integrationTest')
        testTaskName.set('integrationTest')
    }

    // onSuccess block: Actions when tests pass
    onSuccess {
        // Additional tags to apply when tests succeed
        // In sourceRef mode, these are applied as additional aliases to the source image
        additionalTags.set(['verified'])
    }
}

// =============================================================================
// Integration Test Dependencies
// =============================================================================
dependencies {
    integrationTestImplementation files("${rootProject.projectDir}/buildSrc/build/classes/groovy/main")
    integrationTestImplementation libs.rest.assured
    integrationTestImplementation libs.rest.assured.json.path
}

// Configure integration test task with system properties
tasks.named('integrationTest') {
    systemProperty 'COMPOSE_PROJECT_NAME', 'project-scenario2-test'
    systemProperty 'IMAGE_NAME', 'project-scenario2-nginx'
}

// =============================================================================
// Task Orchestration
// =============================================================================
// For sourceRef mode, there's no build task - the image is pulled/tagged directly.
// The plugin handles this automatically, but we still need to wire the test flow.
afterEvaluate {
    // composeUp depends on the tag task (which handles pull + tag for sourceRef)
    tasks.named('composeUpProjectscenario2nginxTest') {
        dependsOn tasks.named('dockerTagProjectscenario2nginx')
    }

    // The integration test flow: composeUp -> tests -> composeDown
    tasks.named('integrationTest') {
        dependsOn tasks.named('composeUpProjectscenario2nginxTest')
        finalizedBy tasks.named('composeDownProjectscenario2nginxTest')
    }
}

// =============================================================================
// Verification Task: Run the full pipeline and verify results
// =============================================================================
tasks.register('runProjectIntegrationTest') {
    description = 'Run the dockerProject pipeline and verify results'
    group = 'verification'

    // Run the pipeline (task name is 'run<ImageName>Pipeline')
    dependsOn tasks.named('runProjectscenario2nginxPipeline')

    doLast {
        // In sourceRef mode, verify the source image was pulled and is available
        // The 'verified' tag is applied as an alias to the source image
        def result = exec {
            commandLine 'docker', 'images', '-q', 'nginx:1.27-alpine'
            standardOutput = new ByteArrayOutputStream()
            ignoreExitValue = true
        }
        def imageId = result.standardOutput.toString().trim()
        if (imageId.isEmpty()) {
            throw new GradleException("Expected source image 'nginx:1.27-alpine' not found! " +
                "The image may not have been pulled.")
        }
        logger.lifecycle("SUCCESS: Source image 'nginx:1.27-alpine' found with ID: ${imageId}")

        // Note: Additional tags (like 'verified') are applied as aliases to the source image
        // The exact tag behavior depends on the DockerService implementation
    }
}

// Cleanup task
tasks.register('cleanupProject') {
    description = 'Clean up Docker resources from dockerProject test'
    group = 'verification'

    doLast {
        // Remove test containers
        exec {
            commandLine 'docker', 'compose', '-p', 'project-scenario2-test', 'down', '-v'
            ignoreExitValue = true
        }

        // Note: In sourceRef mode, we don't remove the source image (nginx:1.27-alpine)
        // as it may be used by other tests. Only clean up test-specific tags if any.
    }
}
